<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>1→6 순서 터치 (랭킹 파서 강화판)</title>
  <style>
    :root{
      --bg:#ffffff; --cell:#ffffff; --cell2:#f2f2f2;
      --ok:#16a34a; --err:#ef4444; --ink:#000000; --muted:#555555;
      --panel:#ffffffee; --border:#00000033; --overlay:#00000066;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background: var(--bg); color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", Arial, sans-serif;
      -webkit-tap-highlight-color: transparent; user-select:none; touch-action: manipulation; overflow: hidden;
    }
    .hud{ position: fixed; left:0; right:0; top:0; z-index: 3; display:flex; flex-wrap: wrap; align-items:center; justify-content:center; gap:8px 10px; padding: calc(8px + env(safe-area-inset-top)) 10px 8px; background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.7) 40%, transparent); font-variant-numeric: tabular-nums; border-bottom: 1px solid var(--border); }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .pill{ background:#0000000a; border:1px solid #00000020; padding:6px 10px; border-radius:999px; }
    .pill strong{letter-spacing:.3px}
    .btn{ border:1px solid #00000030; background:#00000010; color:var(--ink); padding:10px 14px; border-radius:12px; font-weight:700; }
    .name{ display:flex; gap:6px; align-items:center; background:#00000008; border:1px solid #00000020; padding:6px 10px; border-radius:999px; }
    .name input{ background:transparent; border:none; outline:none; color:var(--ink); width:150px; font-weight:700; font-size:16px; }
    .status{ font-size:12px; color:var(--muted); }
    .status.ok{ color: var(--ok); } .status.err{ color: var(--err); }
    .toast{ position: fixed; inset: auto 0 calc(8px + env(safe-area-inset-bottom)) 0; display:flex; justify-content:center; padding: 6px 0; pointer-events:none; z-index:4; }
    .toast .box{ background:#00000033; border:1px solid #00000026; padding:8px 12px; border-radius:12px; font-variant-numeric: tabular-nums; color:#000; }
    .good{color:var(--ok)} .bad{color:var(--err)}
    .grid{ position: fixed; left:0; right:0; z-index:1; display:grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); }
    .cell{ display:flex; align-items:center; justify-content:center; font-size: clamp(44px, 14vw, 120px); font-weight: 900; letter-spacing: .5px; border: 1px solid #00000018; background: var(--cell); transition: transform .02s ease, filter .2s ease, background .3s ease, outline-color .1s ease; color: var(--ink); }
    .cell:active{ transform: scale(.985) }
    .cell.done{ outline: 4px solid #22c55e55; filter: brightness(1.06); }
    .grid.shake{ animation:shake .25s linear }
    @keyframes shake{ 15%, 45%, 75% { transform: translateX(-6px) } 30%, 60%, 90% { transform: translateX(6px) } }
    .sr-only{ position:absolute; width:1px; height:1px; clip:rect(0 0 0 0); white-space:nowrap; overflow:hidden; }
    .panel{ position: fixed; right:10px; bottom: calc(10px + env(safe-area-inset-bottom)); z-index:5; width: min(460px, 92vw); background: var(--panel); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 30px #00000033; padding: 10px; display: none; color: #000; }
    .panel.open{ display:block; }
    .panel header{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .panel h3{ margin:0; font-size:16px; letter-spacing:.2px }
    .panel .close{ border:1px solid #00000030; background:#00000010; color:var(--ink); padding:6px 10px; border-radius:10px; font-weight:700; }
    .panel .admin-line{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .admin-line input{ border:1px solid #00000030; background:#ffffff; color:#000; border-radius:10px; padding:6px 8px; font-size:16px; }
    .admin-line .small{ font-size:12px; color:#4b5563; }
    .table{ width:100%; border-collapse: collapse; font-variant-numeric: tabular-nums; }
    .table th, .table td{ border-bottom:1px solid #0000001a; padding:6px 4px; text-align:left; }
    .table th{ color:#111827; font-size:12px; }
    .table td.rank{ width:2.5ch; text-align:right; }
    .table td.time{ text-align:right; font-weight:800; white-space:nowrap; }
    .table td.ctrl{ width:1%; white-space:nowrap; text-align:right; }
    .dim{ color:#4b5563; font-size:12px; }

    /* Intro toggle (CSS-only) */
    #introToggle{ position:fixed; opacity:0; pointer-events:none; }
    .intro{ position: fixed; inset:0; z-index: 10; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,.45); padding: 20px; }
    #introToggle:not(:checked) + .intro{ display:none; }
    .intro .sheet{ width: min(720px, 96vw); background: #ffffff; border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 30px #00000033; padding: 16px; color: #000; }
    .intro h2{ margin: 0 0 8px 0; font-size: 18px; }
    .intro p{ margin: 6px 0; line-height: 1.5; }
    .intro .note{ color:#16a34a; font-weight:600; }
    .intro .actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .intro .backdrop{ position: absolute; inset:0; display:block; }

    .globalBest{ position: fixed; left:50%; top:50%; transform: translate(-50%,-50%); z-index: 0; pointer-events: none; font-variant-numeric: tabular-nums; text-align: center; opacity: .1; }
    .globalBest .label{ font-size: clamp(12px, 3.2vw, 22px); letter-spacing:.2px; }
    .globalBest .time{ margin-top: 4px; font-weight: 900; font-size: clamp(36px, 18vw, 140px); line-height: 1; }

    .modal{ position: fixed; inset:0; z-index: 9; background: var(--overlay); display:none; align-items:center; justify-content:center; padding: 16px; }
    .modal.open{ display:flex; }
    .modal .card{ width: min(560px, 95vw); background: #ffffff; color:#000; border:1px solid var(--border); border-radius:16px; box-shadow: 0 10px 30px #00000033; padding: 16px; }
    .modal h3{ margin:0 0 8px 0; font-size:18px; }
    .modal .time{ font-weight:900; }
    .modal .name-line{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .modal input{ border:1px solid #00000030; background:#ffffff; color:#000; border-radius:10px; padding:8px 10px; font-size:16px; flex:1; min-width: 160px; }

    .champ{ display:none; align-items:center; gap:6px; background:#fff7ed; border:1px solid #f97316; color:#9a3412; padding:6px 10px; border-radius:999px; font-weight:800; }
    .champ .emoji{ font-size:16px; line-height:1; }
    .champ .label{ font-size:12px; opacity:.9; }
    .champ .name{ max-width:22ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .debug{ margin-top:6px; font-size:12px; color:#6b7280; word-break:break-all; }
    .debug pre{ white-space:pre-wrap; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:8px; padding:8px; max-height:160px; overflow:auto; }
  </style>
</head>
<body>
  <div id="hud" class="hud" aria-live="polite">
    <div class="row">
      <div class="name">
        <span>이름</span>
        <input id="playerName" placeholder="예: JI-YONG" maxlength="24" autocomplete="off" autocapitalize="none">
        <button class="btn" id="saveNameBtn" type="button">저장</button>
      </div>
      <button class="btn" id="restartBtn" type="button" aria-label="다시하기">↻ 다시</button>
      <button class="btn" id="leaderBtn" type="button" aria-label="랭킹">🏆 랭킹</button>
      <div class="champ" id="champPill" title="최근 1주 상위 랭커">
        <span class="emoji" id="champEmojiL">🎉</span>
        <span class="label" id="champLabel">1위</span>
        <span class="name" id="champName">—</span>
        <span class="emoji" id="champEmojiR">🎉</span>
      </div>
    </div>
    <div class="row">
      <div class="pill">시간 <strong id="time">0.000s</strong></div>
      <div class="pill">Top1 <strong id="best">—</strong></div>
      <div class="pill status" id="serverStatus">서버: 확인 중…</div>
    </div>
  </div>

  <div class="grid" id="grid" aria-label="터치 그리드 (1부터 6까지 순서대로 누르기)"></div>

  <div class="globalBest" id="globalBest">
    <div class="label">GLOBAL BEST</div>
    <div class="time" id="globalBestTime">—</div>
  </div>

  <div class="toast" aria-live="polite">
    <div class="box" id="msg"><span class="sr-only">힌트: </span><b>1</b>을 터치하면 시작</div>
  </div>

  <input id="introToggle" type="checkbox" checked aria-hidden="true" />
  <div class="intro" id="intro" role="dialog" aria-modal="true" aria-labelledby="introTitle">
    <label class="backdrop" for="introToggle" aria-label="닫기"></label>
    <div class="sheet">
      <h2 id="introTitle">게임 안내</h2>
      <p>1. 초록색 <span class="note">'서버:연결됨'</span>을 확인 후 시작하세요.</p>
      <p>2. 숫자 1을 누르는 순간 타이머가 시작됩니다.(누르기 전에는 시간 흐르지 않음.)</p>
      <p>3. 랭킹에 올리고 싶은 경우 이름을 입력하고 '저장'을 누르세요.</p>
      <p>4. '랭킹' 버튼을 누르면 Top10 기록이 표시됩니다.</p>
      <div class="actions">
        <label class="btn" for="introToggle">확인</label>
      </div>
    </div>
  </div>

  <div class="panel" id="panel">
    <header>
      <h3>Top 10 랭킹</h3>
      <div class="admin-line">
        <button class="btn" id="refreshBtn" type="button">새로고침</button>
        <button class="btn" id="adminToggle" type="button">관리자 로그인</button>
        <button class="close" id="closePanel" type="button">닫기</button>
      </div>
    </header>

    <div class="admin-line" id="adminArea" style="display:none; margin-bottom:8px;">
      <input id="admId" placeholder="관리자 ID" inputmode="numeric" />
      <input id="admPw" placeholder="관리자 비밀번호" type="password" />
      <button class="btn" id="admLogin" type="button">로그인</button>
      <button class="btn" id="admLogout" type="button" style="display:none;">로그아웃</button>
      <span class="small" id="admStatus"></span>
    </div>

    <div id="boardWrap">
      <div class="dim">랭킹을 불러오는 중…</div>
    </div>
    <div class="dim" id="boardInfo" style="margin-top:6px;"></div>
    <div class="debug" id="debugArea" style="display:none;">
      <div>서버 원본 응답:</div>
      <pre id="debugRaw"></pre>
    </div>
  </div>

  <div class="modal" id="saveModal" aria-hidden="true" aria-labelledby="saveTitle" role="dialog">
    <div class="card">
      <h3 id="saveTitle">기록을 저장하시겠습니까?</h3>
      <p>이번 기록: <span class="time" id="modalTime">0.000s</span></p>
      <div class="name-line">
        <input id="modalName" placeholder="이름을 입력하세요" maxlength="24" autocomplete="off" autocapitalize="none">
      </div>
      <div class="actions">
        <button class="btn" id="saveNo" type="button">아니오</button>
        <button class="btn" id="saveYes" type="button">네 (저장)</button>
      </div>
    </div>
  </div>

  <script>
    // Error surfacing
    window.addEventListener('error', function(e){
      const el = document.querySelector('#serverStatus');
      if (el){ el.className='pill status err'; el.textContent='스크립트 오류: ' + (e.message||''); }
    });

    const DEFAULT_API_BASE = "PUT_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE";
    const PARAM_API = new URLSearchParams(location.search).get('api');
    if (PARAM_API) localStorage.setItem('API_BASE_URL', PARAM_API);
    const API_BASE = PARAM_API || localStorage.getItem('API_BASE_URL') || DEFAULT_API_BASE;
    const TOP_DAYS = 7;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const hud = $('#hud'), grid = $('#grid');
    const timeEl = $('#time'), bestEl = $('#best'), globalBestTime = $('#globalBestTime');
    const msgEl = $('#msg'), nameInput = $('#playerName'), saveNameBtn = $('#saveNameBtn'), serverStatus = $('#serverStatus');
    const panel = $('#panel'), leaderBtn = $('#leaderBtn'), refreshBtn = $('#refreshBtn'), closePanel = $('#closePanel'), boardWrap = $('#boardWrap'), boardInfo = $('#boardInfo');
    const adminToggle = $('#adminToggle'), adminArea = $('#adminArea'), admId = $('#admId'), admPw = $('#admPw'), admLogin = $('#admLogin'), admLogout = $('#admLogout'), admStatus = $('#admStatus');
    const saveModal = $('#saveModal'), modalTime = $('#modalTime'), modalName = $('#modalName'), saveYes = $('#saveYes'), saveNo = $('#saveNo');
    const champPill = $('#champPill'), champName = $('#champName'), champEmojiL = $('#champEmojiL'), champEmojiR = $('#champEmojiR'), champLabel = $('#champLabel');
    const debugArea = $('#debugArea'), debugRaw = $('#debugRaw');

    let next=1,running=false,startTime=0,raf=null,adminCred=null;
    let lastElapsedMs = null;
    const LS_NAME='sixSplitPlayerName';

    function resizeLayout(){ grid.style.top=hud.offsetHeight+'px'; grid.style.bottom='0px'; }
    window.addEventListener('resize',resizeLayout);
    window.addEventListener('orientationchange',()=>setTimeout(resizeLayout,200));

    function init(){
      const stored=localStorage.getItem(LS_NAME)||''; if(stored) nameInput.value=stored;
      bindHud(); bindAdmin(); bindModal();
      renderShuffled(); reset(false); updateServerStatus();
      fetchTop10();
      requestAnimationFrame(resizeLayout); setTimeout(resizeLayout,250);
    }

    function bindHud(){
      $('#restartBtn').addEventListener('click',()=>{ vibrate(10); renderShuffled(); reset(true); });
      saveNameBtn.addEventListener('click',()=>{ const name=nameInput.value.trim(); localStorage.setItem(LS_NAME,name); toast('이름 저장 완료'); });
      leaderBtn.addEventListener('click', async ()=>{ panel.classList.add('open'); boardWrap.innerHTML='<div class="dim">랭킹을 불러오는 중…</div>'; await fetchTop10(); });
      refreshBtn.addEventListener('click', fetchTop10);
      closePanel.addEventListener('click', ()=> panel.classList.remove('open'));
    }

    function bindAdmin(){
      adminToggle.addEventListener('click', ()=>{ adminArea.style.display = adminArea.style.display==='none'?'flex':'none'; });
      $('#admLogin').addEventListener('click', async ()=>{
        const id=admId.value.trim(), pw=admPw.value.trim();
        const ok = await adminAuth(id,pw);
        if (ok){ adminCred={id,pw}; admStatus.textContent='로그인 성공'; admLogout.style.display=''; admLogin.style.display='none'; fetchTop10(); }
        else { admStatus.textContent='로그인 실패'; adminCred=null; }
      });
      $('#admLogout').addEventListener('click', ()=>{ adminCred=null; admStatus.textContent='로그아웃됨'; admLogout.style.display='none'; admLogin.style.display=''; fetchTop10(); });
    }

    function bindModal(){
      saveYes.addEventListener('click', async ()=>{
        const name = (modalName.value || nameInput.value || '').trim();
        if (!name){ alert('이름을 입력해 주세요.'); modalName.focus(); return; }
        localStorage.setItem(LS_NAME, name);
        nameInput.value = name;
        if (getApi()){
          try{ await saveBestToServer(name, lastElapsedMs); toast('기록 저장됨'); }
          catch(e){ toast('저장 실패'); }
        } else { toast('서버 미설정'); }
        closeSaveModal(); afterRoundReset();
      });
      saveNo.addEventListener('click', ()=>{ closeSaveModal(); afterRoundReset(); });
    }

    function renderShuffled(){
      const arr=[1,2,3,4,5,6].sort(()=>Math.random()-.5);
      grid.innerHTML='';
      arr.forEach(n=>{
        const b=document.createElement('button');
        b.className='cell'; b.type='button'; b.dataset.num=String(n);
        b.setAttribute('aria-label',String(n)); b.textContent=String(n);
        b.addEventListener('pointerdown',onTap,{passive:true});
        grid.appendChild(b);
      });
    }

    function onTap(e){
      const introToggle = document.getElementById('introToggle');
      if (introToggle && introToggle.checked) return;
      if (saveModal.classList.contains('open')) return;
      const v=Number(e.currentTarget.dataset.num);
      if (v!==next){ wrong(); return; }
      e.currentTarget.classList.add('done');
      if (next===1){ startTimer(); msgEl.textContent='진행 중…'; }
      if (next===6){ finish(); return; }
      next++;
    }

    function startTimer(){
      running=true; startTime=performance.now(); if(raf) cancelAnimationFrame(raf);
      const tick=()=>{ if(!running) return; timeEl.textContent=((performance.now()-startTime)/1000).toFixed(3)+'s'; raf=requestAnimationFrame(tick); };
      raf=requestAnimationFrame(tick);
    }
    function stopTimer(){ running=false; if(raf) cancelAnimationFrame(raf); raf=null; }

    function finish(){
      stopTimer();
      lastElapsedMs = Math.round(performance.now()-startTime);
      const sec = (lastElapsedMs/1000).toFixed(3);
      timeEl.textContent=sec+'s';
      msgEl.innerHTML=`<span class="good">완료!</span> 기록: <b>${sec}s</b>`;
      vibrate([20,30,60]);
      next=999;
      openSaveModal(sec);
      fetchTop10();
    }

    function wrong(){
      grid.classList.add('shake');
      msgEl.innerHTML=`<span class="bad">순서 오류</span> — 1부터 다시`;
      vibrate([40,50,40]);
      setTimeout(()=> grid.classList.remove('shake'),260);
      afterRoundReset();
    }

    function reset(){
      stopTimer(); next=1; timeEl.textContent='0.000s';
      $$('.cell').forEach(c=>c.classList.remove('done'));
      msgEl.innerHTML='<b>1</b>을 터치하면 시작';
    }

    function afterRoundReset(){ renderShuffled(); reset(false); }
    function getApi(){ const url=(API_BASE||'').trim(); return url && url.startsWith('http') ? url : ''; }

    async function adminAuth(id,pw){
      try{
        const res = await fetch(getApi(), { method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({action:'auth', admin_id:id, admin_pw:pw}) });
        const data = await safeParseResponse(res); return !!(data && data.ok);
      }catch(e){ console.warn('admin auth failed',e); return false; }
    }
    async function adminDelete(name){
      if(!adminCred) return false;
      try{
        const res = await fetch(getApi(), { method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({action:'delete', name, admin_id:adminCred.id, admin_pw:adminCred.pw}) });
        const data = await safeParseResponse(res); return !!(data && data.ok);
      }catch(e){ console.warn('admin delete failed',e); return false; }
    }

    function normalizeRows(rows){
      // Accept: [{name, best_ms}] or [{player, ms/time/duration_ms}] or array of arrays [name, ms]
      const out = [];
      rows.forEach(r=>{
        if (Array.isArray(r) && r.length>=2){
          out.push({ name: String(r[0]||''), best_ms: Number(r[1]) });
        } else if (r && typeof r==='object'){
          const name = String(r.name ?? r.player ?? r.nickname ?? r.user ?? '');
          const ms = Number(r.best_ms ?? r.ms ?? r.time ?? r.duration_ms ?? r.best);
          if (name) out.push({ name, best_ms: ms });
        }
      });
      // filter valid & sort ascending by ms
      return out.filter(x => isFinite(x.best_ms)).sort((a,b)=>a.best_ms-b.best_ms);
    }

    async function safeParseResponse(res){
      const text = await res.text();
      try{
        // strip XSSI `)]}',\n`
        const cleaned = text.replace(/^\)\]\}',?\n/, '');
        return JSON.parse(cleaned);
      }catch(e){
        // try GAS HtmlService JSON-in-HTML (extract {...})
        const m = text.match(/\{[\s\S]*\}$/);
        if (m){ try{ return JSON.parse(m[0]); }catch(_){ /* ignore */ } }
        throw new Error('응답 파싱 실패: ' + text.slice(0,400));
      }
    }

    async function fetchTop10(){
      if (!getApi()){
        setGlobalBest(null); setRotation([]);
        serverStatus.className='pill status err'; serverStatus.textContent='서버: 미설정';
        return;
      }
      let data = null, ok=false, rawText='';
      try{
        const url7 = `${getApi()}?action=top&limit=10&days=${encodeURIComponent(TOP_DAYS)}`;
        const res7 = await fetch(url7, { method:'GET' });
        rawText = await res7.clone().text();
        data = await safeParseResponse(res7);
        ok = !!(data && (Array.isArray(data.top)||Array.isArray(data.rows)||Array.isArray(data.records)));
      }catch(_){}
      if (!ok){
        try{
          const url = `${getApi()}?action=top&limit=10`;
          const res = await fetch(url, { method:'GET' });
          rawText = await res.clone().text();
          data = await safeParseResponse(res);
          ok = !!(data && (Array.isArray(data.top)||Array.isArray(data.rows)||Array.isArray(data.records)));
        }catch(_){}
      }
      if (ok && data){
        serverStatus.className='pill status ok'; serverStatus.textContent='서버: 연결됨';
        const rows = normalizeRows(data.top || data.rows || data.records || []);
        if (rows.length){
          boardWrap.innerHTML = renderBoard(rows);
          setGlobalBest(rows[0].best_ms);
          setRotation(rows);
          debugArea.style.display='none';
        }else{
          boardWrap.innerHTML = '<div class="dim">기록이 없습니다.</div>';
          setGlobalBest(null); setRotation([]);
          // show raw if server gave unexpected shape
          debugArea.style.display='block'; debugRaw.textContent = rawText.slice(0,2000);
        }
        const now = new Date(); boardInfo.textContent = `업데이트: ${now.toLocaleString()}`;
      } else {
        boardWrap.innerHTML = '<div class="dim">랭킹을 불러오지 못했습니다.</div>';
        setGlobalBest(null); setRotation([]);
        serverStatus.className='pill status err'; serverStatus.textContent='서버: 오류(조회 실패)';
        debugArea.style.display='block'; debugRaw.textContent = rawText.slice(0,2000);
      }
    }

    function setGlobalBest(ms){
      const text = (ms && isFinite(ms)) ? (ms/1000).toFixed(3)+'s' : '—';
      globalBestTime.textContent=text; bestEl.textContent=text;
    }

    function setRotation(rows){
      const top3 = rows.slice(0,3).map(r => (String(r.name||'').trim()) ).filter(n => n.length>0);
      if (window._cycleTimer){ clearInterval(window._cycleTimer); window._cycleTimer=null; }
      if (top3.length === 0){ champPill.style.display='none'; champName.textContent='—'; return; }
      champPill.style.display='flex';
      window._cycleData = top3; window._cycleIdx = 0;
      renderChampionFrame(window._cycleIdx);
      window._cycleTimer = setInterval(()=>{
        window._cycleIdx = (window._cycleIdx + 1) % top3.length;
        renderChampionFrame(window._cycleIdx);
      }, 1000);
    }
    function renderChampionFrame(idx){
      const name = (window._cycleData && window._cycleData[idx]) || '—';
      const rank = (idx % 3) + 1;
      champName.textContent = name; champLabel.textContent = `${rank}위`;
      champEmojiL.textContent = (rank===1?'🎉':rank===2?'❤️':'💪');
      champEmojiR.textContent = champEmojiL.textContent;
    }

    function renderBoard(rows){
      if (!rows.length) return '<div class="dim">아직 기록이 없습니다.</div>';
      const admin = !!adminCred;
      const header = `<thead><tr><th>#</th><th>이름</th><th>기록</th>${admin?'<th>관리</th>':''}</tr></thead>`;
      const trs = rows.map((r,i)=>{
        const s=(Number(r.best_ms)/1000).toFixed(3);
        const nm=escapeHtml(String(r.name||''));
        const delBtn = admin ? `<button class="btn btn-del" data-name="${nm}" type="button">삭제</button>` : '';
        return `<tr><td class="rank">${i+1}</td><td class="name">${nm}</td><td class="time">${s}s</td>${admin?`<td class="ctrl">${delBtn}</td>`:''}</tr>`;
      }).join('');
      const table = `<table class="table">${header}<tbody>${trs}</tbody></table>`;
      setTimeout(()=>{
        $$('.btn-del').forEach(b=>b.addEventListener('click', async (e)=>{
          const name=e.currentTarget.getAttribute('data-name');
          if (!confirm(\`'\${name}' 기록을 삭제할까요?\`)) return;
          const ok = await adminDelete(name);
          if (ok){ alert('삭제되었습니다.'); fetchTop10(); } else { alert('삭제 실패(권한 또는 서버 오류)'); }
        }));
      },0);
      return table;
    }

    async function saveBestToServer(name, ms){
      const res = await fetch(getApi(), { method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({ name, ms }) });
      const data = await safeParseResponse(res);
      if (!(data && data.ok)) throw new Error('save failed');
      fetchTop10();
      return data;
    }

    function closeSaveModal(){ saveModal.classList.remove('open'); saveModal.setAttribute('aria-hidden','true'); }
    function openSaveModal(secText){
      modalTime.textContent = secText + 's';
      modalName.value = (nameInput.value || localStorage.getItem(LS_NAME) || '').trim();
      saveModal.classList.add('open'); saveModal.setAttribute('aria-hidden','false');
      setTimeout(()=>modalName.focus(), 0);
    }

    function escapeHtml(str){ return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function updateServerStatus(){ if(getApi()){ serverStatus.className='pill status'; serverStatus.textContent='서버: 확인 중…'; } else { serverStatus.className='pill status err'; serverStatus.textContent='서버: 미설정'; } }
    function vibrate(p){ try{ if('vibrate' in navigator) navigator.vibrate(p); }catch(_){} }
    function toast(text){ msgEl.textContent = text; setTimeout(()=>{ msgEl.textContent = '진행 중…'; }, 1200); }

    init();
  </script>
</body>
</html>

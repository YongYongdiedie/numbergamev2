<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>1→6 순서 터치 게임</title>
  <style>
    :root{
      --bg:#111827; --panel:#1f2937; --ink:#e5e7eb; --muted:#9ca3af;
      --cell:#111827; --cell2:#0f172a; --ok:#10b981; --err:#ef4444; --accent:#60a5fa;
      --border:#374151; --overlay:#00000088;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif}
    .wrap{max-width:800px;margin:0 auto; padding:16px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
    .title{font-weight:700; letter-spacing:.2px}
    .hud{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid var(--border); border-radius:999px; background:var(--panel); font-size:12px; color:var(--muted)}
    .pill b{color:var(--ink)}
    .btn{cursor:pointer; user-select:none; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--ink); font-weight:600}
    .btn:active{transform:translateY(1px)}
    .rank-group{display:flex; align-items:center; gap:8px}
    .ticker{min-width:120px; padding:6px 10px; border:1px dashed var(--border); border-radius:10px; color:var(--accent); background:rgba(96,165,250,0.08); font-weight:700; text-align:center}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); grid-auto-rows:120px; gap:10px; margin-top:8px}
    .cell{
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, var(--cell), var(--cell2));
      border:1px solid var(--border); border-radius:16px;
      font-size:42px; font-weight:800; color:var(--ink);
      box-shadow:0 2px 12px #00000033; transition:transform .05s ease, background .2s ease, box-shadow .2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .cell:active{transform:scale(.98); box-shadow:0 2px 8px #00000022}
    .cell.ok{background:linear-gradient(180deg, #064e3b, #065f46)}
    .cell.bad{background:linear-gradient(180deg, #7f1d1d, #991b1b)}
    .panel{margin-top:14px; padding:12px; border:1px solid var(--border); border-radius:14px; background:var(--panel)}
    .muted{color:var(--muted)}
    .good{color:var(--ok)}
    .err{color:var(--err)}
    .footer{margin-top:12px; display:flex; gap:8px; flex-wrap:wrap}
    .list{margin:0; padding-left:16px}
    .list li{margin:4px 0}
    .hidden{display:none !important}
    .right{margin-left:auto}
    dialog::backdrop{background:var(--overlay)}
    dialog{border:none; border-radius:16px; padding:0; overflow:hidden; background:var(--panel); color:var(--ink); box-shadow:0 20px 80px #00000088; width:min(450px, 92vw)}
    .modal-head{padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700}
    .modal-body{padding:16px; display:grid; gap:12px}
    .modal-foot{padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end}
    input[type="text"]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0b1220; color:var(--ink); outline:none}
    .small{font-size:12px}
    @media (max-width:480px){ .grid{grid-auto-rows:92px} .cell{font-size:36px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">1→6 순서 터치 게임</div>
      <div class="hud">
        <div class="pill">시간: <b id="time">0.000s</b></div>
        <div class="pill" id="serverState">서버: <b class="muted">미설정</b></div>
      </div>
    </header>

    <div class="panel">
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
        <button class="btn" id="startBtn">시작</button>
        <div class="right"></div>
        <div class="rank-group">
          <button class="btn" id="rankBtn">랭킹</button>
          <div class="ticker" id="ticker">Top 1~3 로딩…</div>
        </div>
      </div>
      <div id="msg" class="muted small" style="margin-top:8px">번호 1부터 6까지 순서대로 빠르게 누르세요.</div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="panel">
      <div style="display:flex; align-items:center; gap:8px">
        <div class="muted">이름: </div>
        <input type="text" id="nameInput" placeholder="기록 저장 시 사용됩니다." style="max-width:260px">
        <div class="right"></div>
        <button class="btn" id="apiBtn">API 설정</button>
      </div>
    </div>

    <dialog id="confirmDlg">
      <div class="modal-head">기록 저장</div>
      <div class="modal-body">
        <div>기록을 저장하시겠습니까?</div>
        <div class="muted small">“예”를 누르면 이름 입력 후 기록이 랭킹에 반영됩니다.</div>
      </div>
      <div class="modal-foot">
        <button class="btn" id="noSaveBtn">아니오</button>
        <button class="btn" id="yesSaveBtn">예</button>
      </div>
    </dialog>

    <dialog id="nameDlg">
      <div class="modal-head">이름 입력</div>
      <div class="modal-body">
        <input type="text" id="nameDlgInput" placeholder="예: 홍길동">
      </div>
      <div class="modal-foot">
        <button class="btn" id="cancelNameBtn">취소</button>
        <button class="btn" id="okNameBtn">저장</button>
      </div>
    </dialog>

    <dialog id="rankDlg">
      <div class="modal-head">Top 10 랭킹</div>
      <div class="modal-body">
        <ol class="list" id="rankList"></ol>
        <div class="muted small">가장 빠른 기록 기준(개인별 최고기록).</div>
      </div>
      <div class="modal-foot">
        <button class="btn" id="closeRankBtn">닫기</button>
      </div>
    </dialog>

  </div>

  <script>
    // ========= 서버 설정 =========
    const DEFAULT_API_BASE = "https://script.google.com/macros/s/AKfycbyKgc1s1_mxaOD0TjDLtkt9OLuv6rpHamht2Qw_WRe5dTV_f7HYUSM7O61qnGPq5-oq/exec"; // 배포 URL 삽입 또는 ?api=로 설정
    function getApi(){
      const p = new URLSearchParams(location.search).get('api');
      if (p) localStorage.setItem('apiBase', p);
      return localStorage.getItem('apiBase') || DEFAULT_API_BASE || '';
    }
    function setApi(url){
      localStorage.setItem('apiBase', url || '');
      renderServerState();
    }
    async function renderServerState(){
      const el = document.getElementById('serverState');
      const api = getApi();
      if (!api){ el.innerHTML = '서버: <b class="muted">미설정</b>'; return; }
      el.innerHTML = '서버: <b style="color:'+getCss('--accent')+'">확인 중…</b>';
      try{
        const res = await fetch(api+'?action=top&limit=1', { method:'GET' });
        if (res.ok){ el.innerHTML = '서버: <b style="color:'+getCss('--ok')+'">연결 OK</b>'; }
        else{ el.innerHTML = '서버: <b class="err">오류</b>'; }
      }catch(_){ el.innerHTML = '서버: <b class="err">오류</b>'; }
    }
    function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

    // ========= 게임 상태 =========
    const gridEl = document.getElementById('grid');
    const timeEl = document.getElementById('time');
    const msgEl = document.getElementById('msg');
    const nameInput = document.getElementById('nameInput');
    const confirmDlg = document.getElementById('confirmDlg');
    const nameDlg = document.getElementById('nameDlg');
    const nameDlgInput = document.getElementById('nameDlgInput');
    const rankDlg = document.getElementById('rankDlg');
    const rankList = document.getElementById('rankList');
    const tickerEl = document.getElementById('ticker');

    let startTime = 0;
    let timer = null;
    let next = 1;
    let tickerTimer = null;
    let lastTop = [];

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    function buildGrid(){
      // 1~6을 랜덤 배치
      const nums = shuffle([1,2,3,4,5,6]);
      gridEl.innerHTML = '';
      nums.forEach(n => {
        const d = document.createElement('div');
        d.className = 'cell';
        d.textContent = n;
        d.dataset.num = String(n);
        d.addEventListener('click', onCellClick, {passive:true});
        gridEl.appendChild(d);
      });
      next = 1;
      timeEl.textContent = '0.000s';
      msgEl.textContent = '번호 1부터 6까지 순서대로 빠르게 누르세요.';
    }

    function start(){
      buildGrid();
      startTime = performance.now();
      timer && clearInterval(timer);
      timer = setInterval(()=>{
        const t = performance.now() - startTime;
        timeEl.textContent = (t/1000).toFixed(3)+'s';
      }, 16);
    }

    function restart(){
      stopTimer();
      buildGrid();
    }

    function stopTimer(){
      timer && clearInterval(timer);
      timer = null;
    }

    function vibrate(pat){ try{ navigator.vibrate && navigator.vibrate(pat); }catch(_){} }

    function onCellClick(e){
      const n = Number(e.currentTarget.dataset.num);
      if (n === next){
        e.currentTarget.classList.add('ok');
        if (next === 1) msgEl.innerHTML = '<span class="good">좋아요!</span> 계속!';
        next++;
        if (next === 7){
          finish(); // 완료
        }
      }else{
        e.currentTarget.classList.add('bad');
        msgEl.innerHTML = '<span class="err">틀렸습니다.</span> 다시 시도하세요.';
        vibrate([10,40,80]);
      }
    }

    async function finish(){
      stopTimer();
      const elapsed = performance.now() - startTime;
      const secStr = (elapsed/1000).toFixed(3);
      timeEl.textContent = secStr + 's';
      msgEl.innerHTML = `<span class="good">완료!</span> 기록: <b>${secStr}s</b>`;
      vibrate([20,30,60]);

      // 1) 저장 여부 확인 모달
      confirmDlg.showModal();
      // 버튼 핸들
      const onNo = () => {
        confirmDlg.close();
        cleanup();
        restart(); // 저장 안 함 → 즉시 새 판, 랜덤 배치
      };
      const onYes = async () => {
        confirmDlg.close();
        // 이름 입력 모달 (기본값: 입력칸 또는 기존 입력값)
        nameDlgInput.value = (nameInput.value || '').trim();
        nameDlg.showModal();

        const cancel = () => {
          nameDlg.close();
          cleanup();
          restart(); // 취소 시도 동일하게 새 판
        };
        const ok = async () => {
          const name = nameDlgInput.value.trim();
          if (!name){
            alert('이름을 입력해주세요.');
            return;
          }
          nameDlg.close();
          nameInput.value = name; // 기본 입력칸에도 보존

          const api = getApi();
          if (api){
            try{
              await fetch(api, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({ action:'submit', name, best_ms: Math.round(elapsed) })
              });
              await fetchTop10(); // 업로드 후 랭킹 즉시 갱신
            }catch(err){
              console.warn('submit failed', err);
              alert('서버 저장에 실패했습니다.');
            }
          }else{
            alert('API가 설정되지 않아 저장할 수 없습니다. "API 설정" 버튼을 눌러 URL을 등록하세요.');
          }
          cleanup();
          restart(); // 저장 후 새 판
        };

        document.getElementById('cancelNameBtn').onclick = cancel;
        document.getElementById('okNameBtn').onclick = ok;
      };

      document.getElementById('noSaveBtn').onclick = onNo;
      document.getElementById('yesSaveBtn').onclick = onYes;

      function cleanup(){
        document.getElementById('noSaveBtn').onclick = null;
        document.getElementById('yesSaveBtn').onclick = null;
        document.getElementById('cancelNameBtn').onclick = null;
        document.getElementById('okNameBtn').onclick = null;
      }
    }

    // ========= 랭킹 =========
    async function fetchTop10(){
      const api = getApi();
      if (!api) return;
      try{
        const res = await fetch(api+'?action=top&limit=10');
        const data = await res.json();
        if (!data || !data.ok) return;
        const arr = data.top || [];
        // 리스트 채우기
        rankList.innerHTML = '';
        arr.forEach((r, i)=>{
          const li = document.createElement('li');
          const sec = (r.best_ms/1000).toFixed(3)+'s';
          li.textContent = `${i+1}. ${r.name} — ${sec}`;
          rankList.appendChild(li);
        });
        lastTop = arr.slice(0,3);
        refreshTicker();
      }catch(e){
        console.warn(e);
      }
    }

    // Top 1~3 자동회전
    function refreshTicker(){
      if (tickerTimer){ clearInterval(tickerTimer); tickerTimer = null; }
      let idx = 0;
      const show = () => {
        if (!lastTop.length){
          tickerEl.textContent = 'Top 1~3 없음';
          return;
        }
        const item = lastTop[idx % lastTop.length];
        tickerEl.textContent = `${idx%lastTop.length+1}위: ${item.name}`;
        idx++;
      };
      show();
      tickerTimer = setInterval(show, 1000); // 1초 간격
    }

    // ========= UI 이벤트 =========
    document.getElementById('startBtn').addEventListener('click', start);
    document.getElementById('rankBtn').addEventListener('click', async ()=>{
      await fetchTop10();
      rankDlg.showModal();
    });
    document.getElementById('closeRankBtn').addEventListener('click', ()=>rankDlg.close());
    document.getElementById('apiBtn').addEventListener('click', ()=>{
      const cur = getApi();
      const url = prompt('Apps Script 웹 앱 URL을 입력하세요.\n(예: https://script.google.com/macros/s/.../exec)\n\n현재값:\n'+(cur||'(미설정)'));
      if (url !== null){
        setApi(url.trim());
        fetchTop10().then(()=>refreshTicker());
      }
    });

    // ========= 초기화 =========
    (async function init(){
      await renderServerState();
      buildGrid();
      fetchTop10().then(()=>refreshTicker());
    })();
  </script>
</body>
</html>
